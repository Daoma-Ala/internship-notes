
# Workflow Filters en TaskRouter

Los **Workflow Filters** son las reglas de enrutamiento que evalúan las **Tasks** entrantes y asignan cada una a la **TaskQueue** adecuada. Los filtros se evalúan en el orden en que están definidos en el **Workflow**; el primer filtro que coincida con la **Task** se ejecuta. Cada filtro consta de una expresión que decide si la **Task** coincide con el filtro y luego aplica una serie de **Targets** (o pasos de enrutamiento).

![[Pasted image 20250203212141.png]]

- +Objetivos (targets)
	Los objetivos describen la lista de colas de tareas a las que se puede enviar una tarea coincidente. La tarea seguirá recorriendo esta lista de objetivos en secuencia hasta que se encuentre un trabajador adecuado y se cree una reserva.

	Siempre que se alcanza un tiempo de espera para un objetivo determinado (o si se utiliza la expresión skip_if como se explicará más adelante), la tarea se moverá al siguiente objetivo.

	Opcionalmente, la prioridad de las tareas se puede modificar en cada paso para ayudar a asignar tareas con espera más larga más rápido.
	


- +Cola de tareas predeterminada (Default TaskQueue)
	Si una tarea recorre un flujo de trabajo hasta el punto en que se queda sin filtros o destinos, se enviará a una cola de tareas predeterminada definida para ese flujo de trabajo. Si no hay una cola de tareas predeterminada definida, la tarea saldrá del flujo de trabajo y no se podrá crear.

---

## Filter Expressions (Expresiones de Filtro)

Las expresiones utilizan una notación similar a SQL (más sobre esto más adelante). Por ejemplo:

```plaintext
selected_language == "en" AND selected_product == "sales"
```

### Sintaxis similar a SQL para expresiones de filtro

---

## Targets (Objetivos)

Cada **Target** hace referencia a una **TaskQueue** y, si se invoca, enviará la **Task** a esa **TaskQueue**.

- La misma **TaskQueue** puede ser referenciada por más de un **Target**.
- Opcionalmente, puedes definir **prioridad** y **timeout**, lo que te permite implementar cosas como enrutamiento basado en prioridad y escalamientos basados en el tiempo pasado en la cola.
- Puedes profundizar aún más y definir una expresión de **Worker** dentro de un **Target** para seleccionar solo un subconjunto de **Workers** de la **TaskQueue** dada que puedan recibir una **Task**. Por ejemplo, un **Target** para clientes de soporte premium podría configurarse para seleccionar solo **Workers** altamente experimentados, así:

```plaintext
worker.support_experience > 7
```

### Ejemplo de expresión de Worker

---

## Ordenación de Workers

Por defecto, TaskRouter enruta las **Tasks** a los agentes que han estado inactivos por más tiempo. Si deseas cambiar este orden predeterminado (por ejemplo, para asignar los agentes más capacitados a clientes de alto valor), puedes usar la cláusula **order_by**.

- La cláusula **order_by** es una parte opcional de cada definición de **Target**.
- La cláusula **order_by** solo funciona con atributos numéricos de **Workers** y permite clasificar fácilmente por uno o más atributos numéricos. Por ejemplo:

```plaintext
"order_by" : "worker.sales_close_rate DESC"
"order_by" : "worker.skill_level DESC, worker.support_handle_time ASC"
```

### Ejemplos de cláusula order_by

---

## Saltar basado en la disponibilidad de Workers

Cuando una **Task** se asigna a un **Target** y no hay **Workers** disponibles en la **TaskQueue** correspondiente, el comportamiento predeterminado es que la **Task** espere en esa **TaskQueue** hasta que algún **Worker** esté disponible o hasta que se alcance el **timeout**.

Sin embargo, esto no siempre es deseable, y es posible que desees que la **Task** pase inmediatamente al siguiente **Target** de enrutamiento en ciertas situaciones.

- La cláusula **skip_if** te permite saltar un **Target** para la asignación basado en alguna condición predefinida.
- Cuando usas esta cláusula, TaskRouter inspeccionará la **TaskQueue** asignada para ver si coincide con la condición **skip_if**.
- Si se cumple la condición **skip_if**, TaskRouter omitirá el **Target** dado por completo y pasará al siguiente **Target** de enrutamiento para garantizar que las **Tasks** se manejen lo más rápido posible.

```plaintext
"skip_if" : "workers.available < 5"
"skip_if" : "workers.unavailable > 4"
```

### Ejemplos de cláusula skip_if

---

## Escalamiento de Tasks

Como ya se mencionó anteriormente, TaskRouter puede manejar automáticamente el escalamiento y la priorización de **Tasks**.

Puedes agregar un **Target** adicional a cualquier filtro de **Workflow** que se accederá una vez que una **Reservation** haya agotado el tiempo de espera. Esto te permite asignar una **Task** a una **TaskQueue** diferente y, opcionalmente, cambiar la prioridad de la **Task**.

### 

**Knowledge check**

What happens if there is no default TaskQueue defined, and no filter matches the given Task?

The Task will **fail to be created** as it cannot be matched to any filter.