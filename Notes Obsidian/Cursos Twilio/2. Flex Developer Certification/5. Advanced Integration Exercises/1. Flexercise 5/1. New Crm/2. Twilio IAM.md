**Gestión de Identidad y Acceso (IAM) de Twilio**  

Para recapitular la lección anterior, aprendimos que cuando un usuario inicia sesión en la interfaz de Flex, se crea un token JWT para las interacciones posteriores del cliente con los servicios subyacentes en los que se construye Flex.  

Podemos acceder a este token de manera programática en nuestra interfaz de Flex para permitir una comunicación autenticada y autorizada con una función de Twilio, lo cual es genial porque eso es exactamente lo que queremos hacer.  

Sin embargo, antes de sumergirnos en eso, tomemos un desvío rápido y echemos un vistazo al token JWT real. También usaremos la API de IAM de Twilio para decodificar algunos de los datos codificados en el token.  

En primer lugar, necesitaremos obtener el token de un usuario que haya iniciado sesión en Flex. Para hacer eso, debes haber iniciado sesión en tu instancia de Flex. Si aún no has iniciado sesión, hazlo [aquí]. Una vez hecho esto, abre las Herramientas de Desarrollo en tu navegador, ve a la pestaña Consola e ingresa lo siguiente:  

```javascript
Twilio.Flex.Manager.getInstance().user.token
```  

![[Pasted image 20250224134505.png]]
Al hacer esto, se imprimirá en la consola el token JWT que se está utilizando en Flex.  

Copia el texto que se muestra en la consola. En el ejemplo aquí, es el texto rojo que puedes ver en la parte inferior de la consola.  

A continuación, veremos qué hay dentro del token utilizando la API de IAM de Twilio.  

Usando una herramienta como CURL en la línea de comandos o Postman, puedes hacer un POST del token a un punto de validación que forma parte de la API de IAM de Twilio. Y si el token es válido, la API devolverá el payload del JWT.  

Usaremos un comando de CURL para hacer esto. Si bien puedes construir una línea de comandos con todo el token JWT incrustado, puede resultarte más fácil poner el token en un archivo al que podamos hacer referencia desde la línea de comandos.  

Copia el token que viste en la Consola de Herramientas de Desarrollo y pégalo en un archivo llamado `token.json` que contenga algo como esto:  

```json
{"token": "eyJ6aXAiOiJERUYiLCJraW.......el resto del token"}
```  

Una vez que hayas guardado eso en tu computadora, abre una terminal y navega (`cd`) al directorio que contiene el `token.json`. Una vez allí, podrás ejecutar el siguiente comando:  

```bash
curl -X POST https://iam.twilio.com/v1/Accounts/$ACCOUNT_SID/Tokens/validate -H "Content-Type: application/json" --data @token.json -u $ACCOUNT_SID:$AUTH_TOKEN
```  

No olvides sustituir `$ACCOUNT_SID` y `$AUTH_TOKEN` en el fragmento anterior con los valores reales que puedes encontrar para tu proyecto de Flex en la consola web de Twilio.  

El comando anterior devolverá el payload del JWT decodificado y se verá algo así:  

```json
{
  "code": 0,
  "worker_sid": "WKal0ad0fnum63r5andl3tt3r5",
  "roles": [
    "admin",
    "supervisor"
  ],
  "realm_user_id": null,
  "valid": true,
  "expiration": "2020-10-20T14:22:14Z",
  "message": null,
  "identity": "jowling"
}
```  

Como puedes ver, el token muestra la identidad del usuario que ha iniciado sesión y también algo que nos será útil más adelante, es decir, los roles del usuario.  

Solo para ver qué sucede si alguien manipula el token, entra en tu archivo `token.json` y cambia algunos caracteres del token. Verás algo como esto:  

```json
{
    "code": 20151,
    "worker_sid": null,
    "roles": null,
    "realm_user_id": null,
    "valid": false,
    "expiration": null,
    "message": "La autorización con el Token falló",
    "identity": null
}
```  

Hay otros posibles errores y mensajes de error que pueden devolverse, pero el punto es que al cambiar los datos habrás invalidado el token.  

**Resumen**  

En esta lección vimos:  

- Cómo obtener el token JWT de un usuario que ha iniciado sesión.  
- Cómo validar un token JWT utilizando la API de IAM de Twilio.  
- Qué contiene el payload del JWT en una aplicación de Flex.  

En la próxima lección práctica, veremos la función de Twilio que utilizaremos desde nuestro plugin de Flex.