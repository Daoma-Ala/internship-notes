**Actualización del código del plugin para pasar un token JWT a la función proxy**  

Ahora que tenemos nuestra función proxy de OwlCRM en su lugar y sabemos un poco sobre los tokens JWT en general, vamos a actualizar el código de ejemplo del repositorio de Git. Actualizaremos el código del plugin para pasar un token JWT a la función proxy. Como se mencionó antes, la función validará el token, pero también usará los datos del token para permitir el acceso a las preguntas y respuestas de seguridad del cliente.  

Dado que estamos extendiendo la funcionalidad del Flexercise #4, echemos un vistazo rápido a lo que queremos lograr en la interfaz de usuario.  

---

**Interfaz de usuario deseada**  

1. **Mostrar detalles del cliente**:  
   Cuando se acepta una tarea, los detalles del cliente se muestran en el panel derecho. La información básica que vemos se obtuvo de OwlCRM en el IVR.  

   ![[Pasted image 20250224135610.png]]

   Si el usuario que ha iniciado sesión tiene el rol de supervisor, verá un botón para mostrar las preguntas de seguridad del cliente.  

2. **Mostrar las preguntas de seguridad**:  
   Si el usuario hace clic en el botón "Mostrar" y hay un problema con la validación del token JWT, o si no hemos escrito código para pasar el token junto con la solicitud, el usuario verá un mensaje de error como el que se muestra aquí.  
![[Pasted image 20250224135624.png]]


   Por otro lado, si el agente tiene los permisos correctos, se proporcionó un JWT en la solicitud y el token es válido, entonces se mostrarán las respuestas a las preguntas de seguridad del cliente.  

![[Pasted image 20250224135654.png]]
1. **Verificación de roles**:  
   También debemos verificar el rol del usuario en el lado del plugin de Flex. Si no tienen los permisos correctos para ver las preguntas de seguridad del cliente, no verán el botón para revelarlas, solo un mensaje informativo.  

![[Pasted image 20250224135706.png]]

---

**Archivos en el repositorio de Github**  

En el directorio `plugin-feathercorp-fx5` del repositorio de Github que revisamos en la última lección, verás estos archivos. El archivo en el que trabajaremos es `SecurityQuestions.jsx`.  

```
# src/
FeathercorpFx5Plugin.js      # archivo principal del plugin
FeatherCorpTheme.js          # tema de color del plugin

# src/components/CustomCRM
Common.Styles.js             # estilos de componentes compartidos
CustomCRM.js                 # archivo principal del componente CRM
CustomCRM.Styles.js          # estilos del componente CRM
SecurityQuestions.jsx        # aquí haremos nuestros cambios
SecurityQuestions.Styles.js  # (ignorar por ahora)
```  

---

**Actualización del código**  

Los fragmentos de código que debes completar están resaltados en el siguiente snippet:  

```javascript
// verifica si el agente está autorizado y oculta este componente si no lo está
// (esto es solo una medida de conveniencia, no de seguridad, ya que
// la función proxy maneja el control de acceso)
this.authorized =
  this.props.manager.user.roles.includes('supervisor') ||
  // incluir cualquier usuario específico que desees permitir (por ejemplo, para pruebas)
  this.props.manager.user.identity === 'jowling';

// recupera las preguntas de seguridad usando la función de Twilio como proxy
getSecQuestions() {
  this.setState({ questions: 'Cargando...' });
  // primero, verifica si el número de cuenta se proporciona a través de los atributos de la tarea
  if (
    !(
      this.props.task &&
      this.props.task.attributes &&
      this.props.task.attributes.account_number
    )
  ) {
    this.setState({ questions: 'Error: Número de cuenta no encontrado' });
  } else {
    // si hay un número de cuenta, obtén las preguntas de seguridad
    // (usamos POST para evitar pasar el token como un parámetro de consulta)
    fetch(null /* inserta la URL de la función proxy */, {
      method: 'POST',
      headers: {
        'content-type': 'application/json'
      },
      body: JSON.stringify({
        id: null /* el número de cuenta de los atributos de la tarea */,
        token: null /* el token JWT del usuario */
      })
    })
      .then(async (response) => {
        if (response.ok) {
          return response.json();
        } else {
          // lanza un error si recibimos algún error de la Función
          console.error(response);
          if (response.status && response.body) {
            throw new Error(
              `La función proxy devolvió "${await response.text()}"`
            );
          } else {
            throw new Error("No se pudieron obtener las preguntas del CRM");
          }
        }
      })
      .then((questions) => {
        // guarda las preguntas obtenidas en el estado del componente
        this.setState({ questions: questions.security_questions });
      })
      // maneja errores de la Función o lanzados durante la solicitud
      .catch((error) => {
        console.error('La obtención de preguntas de seguridad falló:', error);
        this.setState({
          questions: error.toString()
        });
      });
  }
}
```  

---

**Pasos para completar el código**  

1. **Agrega la URL de la función `crm-proxy` de Twilio**.  
2. **Agrega el número de cuenta del cliente desde los atributos de la tarea al cuerpo de la solicitud**.  
3. **Agrega el token JWT al cuerpo de la solicitud**.  

Cuando estés listo para probar tu código localmente, asegúrate de ejecutar `npm install` en el directorio `plugin-feathercorp-fx5` y luego ejecuta `twilio flex:plugins:start` para ejecutar el plugin localmente.  

---

**Pistas si te quedas atascado**  

- La URL de la función se puede encontrar en la consola de Funciones.  
- Recuerda los atributos de la tarea si estás buscando el número de cuenta.  
- Cuando un usuario ha iniciado sesión, hay un token JWT adjunto directamente al objeto del usuario.  

En el siguiente snippet, hemos:  

1. Agregado una URL como argumento a `fetch`.  
2. Agregado un "id" al cuerpo del POST: el valor se obtuvo de los atributos de la tarea.  
3. Agregado un "token" al cuerpo: este se estableció en el valor de `this.props.manager.user.token`, es decir, el token JWT.  

```javascript
// La URL real de tu función
fetch('https://runtime-domain-1111-dev.twil.io/crm-proxy', {
    method: 'POST',
    headers: {
        'content-type': 'application/json'
    },
    body: JSON.stringify({
        id: this.props.task.attributes.account_number,
        token: this.props.manager.user.token
    })
});
```  

---

**Resumen**  

Eso es todo lo que necesitas hacer en este laboratorio. Para resumir lo que hemos visto:  

- Cómo acceder al token JWT de un usuario de Flex que ha iniciado sesión.  
- Cómo hacer una solicitud HTTP POST con un token JWT en el cuerpo.  

---

**Conclusión**  

Ahora estás listo para probar tu aplicación. Inicia sesión en Flex y revisa una tarea entrante en la interfaz de Flex. Usando el número de teléfono de tu proyecto de Flex, realiza una llamada y sigue la ruta del IVR que termina con la tarea siendo transferida a un agente.  

Nota: Si revisas tanto la verificación del rol del usuario en el plugin (`SecurityQuestions.jsx`, líneas 18 a 20) como en la función (`crm-proxy.js`, líneas 36 a 38), hay una verificación adicional para el nombre del usuario. Puedes modificar cualquiera de estos valores (rol y nombre de usuario) en ambos lados para ver los diferentes estados y cómo afectan la experiencia del usuario.  

¡Adelante, experimenta cambiando el rol esperado y/o el nombre de usuario en ambos lugares! Recuerda que necesitarás volver a implementar la función si haces algún cambio.  

¡De lo contrario, has terminado con el Flexercise #5! ¡Bien hecho! 🎉