**Actualizaci贸n del c贸digo del plugin para pasar un token JWT a la funci贸n proxy**  

Ahora que tenemos nuestra funci贸n proxy de OwlCRM en su lugar y sabemos un poco sobre los tokens JWT en general, vamos a actualizar el c贸digo de ejemplo del repositorio de Git. Actualizaremos el c贸digo del plugin para pasar un token JWT a la funci贸n proxy. Como se mencion贸 antes, la funci贸n validar谩 el token, pero tambi茅n usar谩 los datos del token para permitir el acceso a las preguntas y respuestas de seguridad del cliente.  

Dado que estamos extendiendo la funcionalidad del Flexercise #4, echemos un vistazo r谩pido a lo que queremos lograr en la interfaz de usuario.  

---

**Interfaz de usuario deseada**  

1. **Mostrar detalles del cliente**:  
   Cuando se acepta una tarea, los detalles del cliente se muestran en el panel derecho. La informaci贸n b谩sica que vemos se obtuvo de OwlCRM en el IVR.  

   ![[Pasted image 20250224135610.png]]

   Si el usuario que ha iniciado sesi贸n tiene el rol de supervisor, ver谩 un bot贸n para mostrar las preguntas de seguridad del cliente.  

2. **Mostrar las preguntas de seguridad**:  
   Si el usuario hace clic en el bot贸n "Mostrar" y hay un problema con la validaci贸n del token JWT, o si no hemos escrito c贸digo para pasar el token junto con la solicitud, el usuario ver谩 un mensaje de error como el que se muestra aqu铆.  
![[Pasted image 20250224135624.png]]


   Por otro lado, si el agente tiene los permisos correctos, se proporcion贸 un JWT en la solicitud y el token es v谩lido, entonces se mostrar谩n las respuestas a las preguntas de seguridad del cliente.  

![[Pasted image 20250224135654.png]]
1. **Verificaci贸n de roles**:  
   Tambi茅n debemos verificar el rol del usuario en el lado del plugin de Flex. Si no tienen los permisos correctos para ver las preguntas de seguridad del cliente, no ver谩n el bot贸n para revelarlas, solo un mensaje informativo.  

![[Pasted image 20250224135706.png]]

---

**Archivos en el repositorio de Github**  

En el directorio `plugin-feathercorp-fx5` del repositorio de Github que revisamos en la 煤ltima lecci贸n, ver谩s estos archivos. El archivo en el que trabajaremos es `SecurityQuestions.jsx`.  

```
# src/
FeathercorpFx5Plugin.js      # archivo principal del plugin
FeatherCorpTheme.js          # tema de color del plugin

# src/components/CustomCRM
Common.Styles.js             # estilos de componentes compartidos
CustomCRM.js                 # archivo principal del componente CRM
CustomCRM.Styles.js          # estilos del componente CRM
SecurityQuestions.jsx        # aqu铆 haremos nuestros cambios
SecurityQuestions.Styles.js  # (ignorar por ahora)
```  

---

**Actualizaci贸n del c贸digo**  

Los fragmentos de c贸digo que debes completar est谩n resaltados en el siguiente snippet:  

```javascript
// verifica si el agente est谩 autorizado y oculta este componente si no lo est谩
// (esto es solo una medida de conveniencia, no de seguridad, ya que
// la funci贸n proxy maneja el control de acceso)
this.authorized =
  this.props.manager.user.roles.includes('supervisor') ||
  // incluir cualquier usuario espec铆fico que desees permitir (por ejemplo, para pruebas)
  this.props.manager.user.identity === 'jowling';

// recupera las preguntas de seguridad usando la funci贸n de Twilio como proxy
getSecQuestions() {
  this.setState({ questions: 'Cargando...' });
  // primero, verifica si el n煤mero de cuenta se proporciona a trav茅s de los atributos de la tarea
  if (
    !(
      this.props.task &&
      this.props.task.attributes &&
      this.props.task.attributes.account_number
    )
  ) {
    this.setState({ questions: 'Error: N煤mero de cuenta no encontrado' });
  } else {
    // si hay un n煤mero de cuenta, obt茅n las preguntas de seguridad
    // (usamos POST para evitar pasar el token como un par谩metro de consulta)
    fetch(null /* inserta la URL de la funci贸n proxy */, {
      method: 'POST',
      headers: {
        'content-type': 'application/json'
      },
      body: JSON.stringify({
        id: null /* el n煤mero de cuenta de los atributos de la tarea */,
        token: null /* el token JWT del usuario */
      })
    })
      .then(async (response) => {
        if (response.ok) {
          return response.json();
        } else {
          // lanza un error si recibimos alg煤n error de la Funci贸n
          console.error(response);
          if (response.status && response.body) {
            throw new Error(
              `La funci贸n proxy devolvi贸 "${await response.text()}"`
            );
          } else {
            throw new Error("No se pudieron obtener las preguntas del CRM");
          }
        }
      })
      .then((questions) => {
        // guarda las preguntas obtenidas en el estado del componente
        this.setState({ questions: questions.security_questions });
      })
      // maneja errores de la Funci贸n o lanzados durante la solicitud
      .catch((error) => {
        console.error('La obtenci贸n de preguntas de seguridad fall贸:', error);
        this.setState({
          questions: error.toString()
        });
      });
  }
}
```  

---

**Pasos para completar el c贸digo**  

1. **Agrega la URL de la funci贸n `crm-proxy` de Twilio**.  
2. **Agrega el n煤mero de cuenta del cliente desde los atributos de la tarea al cuerpo de la solicitud**.  
3. **Agrega el token JWT al cuerpo de la solicitud**.  

Cuando est茅s listo para probar tu c贸digo localmente, aseg煤rate de ejecutar `npm install` en el directorio `plugin-feathercorp-fx5` y luego ejecuta `twilio flex:plugins:start` para ejecutar el plugin localmente.  

---

**Pistas si te quedas atascado**  

- La URL de la funci贸n se puede encontrar en la consola de Funciones.  
- Recuerda los atributos de la tarea si est谩s buscando el n煤mero de cuenta.  
- Cuando un usuario ha iniciado sesi贸n, hay un token JWT adjunto directamente al objeto del usuario.  

En el siguiente snippet, hemos:  

1. Agregado una URL como argumento a `fetch`.  
2. Agregado un "id" al cuerpo del POST: el valor se obtuvo de los atributos de la tarea.  
3. Agregado un "token" al cuerpo: este se estableci贸 en el valor de `this.props.manager.user.token`, es decir, el token JWT.  

```javascript
// La URL real de tu funci贸n
fetch('https://runtime-domain-1111-dev.twil.io/crm-proxy', {
    method: 'POST',
    headers: {
        'content-type': 'application/json'
    },
    body: JSON.stringify({
        id: this.props.task.attributes.account_number,
        token: this.props.manager.user.token
    })
});
```  

---

**Resumen**  

Eso es todo lo que necesitas hacer en este laboratorio. Para resumir lo que hemos visto:  

- C贸mo acceder al token JWT de un usuario de Flex que ha iniciado sesi贸n.  
- C贸mo hacer una solicitud HTTP POST con un token JWT en el cuerpo.  

---

**Conclusi贸n**  

Ahora est谩s listo para probar tu aplicaci贸n. Inicia sesi贸n en Flex y revisa una tarea entrante en la interfaz de Flex. Usando el n煤mero de tel茅fono de tu proyecto de Flex, realiza una llamada y sigue la ruta del IVR que termina con la tarea siendo transferida a un agente.  

Nota: Si revisas tanto la verificaci贸n del rol del usuario en el plugin (`SecurityQuestions.jsx`, l铆neas 18 a 20) como en la funci贸n (`crm-proxy.js`, l铆neas 36 a 38), hay una verificaci贸n adicional para el nombre del usuario. Puedes modificar cualquiera de estos valores (rol y nombre de usuario) en ambos lados para ver los diferentes estados y c贸mo afectan la experiencia del usuario.  

隆Adelante, experimenta cambiando el rol esperado y/o el nombre de usuario en ambos lugares! Recuerda que necesitar谩s volver a implementar la funci贸n si haces alg煤n cambio.  

隆De lo contrario, has terminado con el Flexercise #5! 隆Bien hecho! 