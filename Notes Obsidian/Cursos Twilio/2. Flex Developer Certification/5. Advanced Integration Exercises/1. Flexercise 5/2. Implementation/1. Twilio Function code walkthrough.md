**Lección: Código de la función proxy de Twilio para OwlCRM**  

En esta lección, vamos a revisar el código de una función proxy de Twilio para OwlCRM. Es una función muy similar a la que vimos en el Flexercise #4. Pero, como vimos en lecciones anteriores, un token válido deberá acompañar cualquier solicitud HTTP desde nuestro plugin de Flex.  

Ahora que tienes las herramientas necesarias, revisa el código desde este repositorio. Contiene el código del plugin y la función para este curso.  

---

**He revisado el código del repositorio de Github**  

Hay dos directorios principales en este repositorio que has revisado:  

1. **plugin-feathercorp-fx5**: Contiene el código del plugin con el que trabajaremos más adelante.  
2. **runtime**: Contiene nuestra función de Twilio. Comienza navegando (`cd`) al directorio `runtime`.  

Los archivos y directorios que nos interesan son los siguientes:  

```
# runtime/
.env.sample

# runtime/functions
crm-proxy.js
```  

Echemos un vistazo a la función primero. No vamos a revisar todo el archivo aquí, solo los aspectos más destacados. Haz clic en continuar para ver un recorrido rápido del código de la función.  

---

**Recorrido por el código de la función**  

1. **Validación del token**:  
   Lo primero que verás es un nuevo `require` de un `TokenValidator`. Este paquete es necesario para validar que las solicitudes estén acompañadas de un token válido. El `TokenValidator` validará y decodificará el token para que pueda ser utilizado en el resto de la función.  

   ```javascript
   const TokenValidator = require('twilio-flex-token-validator').validator;
   const crmUrl = 'https://owlcrm-4339-dev.twil.io';
   ```  

2. **Uso del TokenValidator**:  
   El `TokenValidator` toma un token JWT, accedido a través del objeto `event`. El token debe ser parte del cuerpo de una solicitud HTTP POST.  

   Con las funciones de Twilio, cualquier parámetro de una solicitud HTTP GET o POST se establece como claves en el objeto `event`. También toma el `ACCOUNT_SID` y `AUTH_TOKEN`, que el entorno de ejecución de la función pasa automáticamente a la función a través del objeto `context`.  

   ```javascript
   TokenValidator(event.token, context.ACCOUNT_SID, context.AUTH_TOKEN)
       .then((tokenResult) => {
         // token validado
         ...
   ```  

3. **Uso del token decodificado**:  
   Si el token es válido, terminaremos en el bloque `then` con un `tokenResult` listo para ser utilizado. En el siguiente fragmento, puedes ver que, como tenemos un token decodificado y desencriptado, podemos verificar quién es el usuario o sus roles.  

   ```javascript
   if (
       tokenResult.roles.includes('supervisor') ||
       // incluir cualquier usuario específico que desees permitir (por ejemplo, para pruebas)
       tokenResult.identity === 'jowling'
   )
   ```  

   Modifica la verificación `tokenResult.identity` anterior para usar el nombre de usuario de tu usuario de prueba si deseas que ese usuario vea las preguntas de seguridad más adelante.  

4. **Manejo de errores de validación**:  
   Si la validación del token falla, el código captura ese error y devuelve un código de estado HTTP 403.  

   ```javascript
   ).catch((err) => {
       // la validación del token falló
       response.setBody('La validación del token falló');
       response.setStatusCode(403);
       return callback(null, response);
   });
   ```  

---

**Puntos clave**  

- Un JWT en una solicitud HTTP POST a una función puede ser accedido a través del objeto `event`.  
- Si la validación del JWT es exitosa, el payload se devuelve y está disponible para nuestro código.  
- Cualquier parámetro de una solicitud HTTP GET o POST pasado a una función de Twilio se establece en el objeto `event` por el entorno de ejecución y, por lo tanto, puede ser accedido desde el objeto `event`.  
- Si un token es validado, el objeto resultante devuelto es el payload desencriptado y decodificado del token.  

---

**Resumen**  

En esta lección:  

- Revisamos el código para nuestro plugin de Flex y la función de Twilio.  
- Vimos el uso del `TokenValidator` para validar solicitudes a una función.  
- Examinamos los roles de los usuarios para autenticar el acceso a un recurso.  

Ahora que hemos terminado con el recorrido del código, pasemos a implementarlo usando la CLI de Twilio.

