# Provisión y gestión de usuarios

En una lección anterior, vimos una descripción general del flujo de inicio de sesión SSO en Flex. Ahora vamos a examinar un aspecto que no se mostró en el diagrama anterior, específicamente la provisión y gestión de usuarios en Flex.

Si recuerdas nuestro diagrama original del flujo de inicio de sesión, se omitieron algunos detalles por brevedad. En particular, pasamos por alto el hecho de que Joe Owling se crearía automáticamente como agente, administrador, supervisor de Flex, o los tres, si eso es lo que elegiste en el formulario de inicio de sesión del IdP.

El diagrama a continuación muestra las partes adicionales del proceso de provisión de usuarios de Flex.
![[Pasted image 20250224211453.png]]

Un usuario que inicia sesión a través de SSO se creará si sus detalles no existen previamente en Flex, o se actualizará si alguno de sus atributos ha cambiado desde el último inicio de sesión.

La aserción SAML de un IdP puede contener cualquier número de atributos (pares clave-valor) en la "declaración de atributos". A veces, estos pueden denominarse "reclamaciones". Hay tres atributos obligatorios requeridos para SSO en Flex:

- **full_name** (nombre completo)
- **email** (correo electrónico)
- **roles** (una lista de cadenas, que contenga uno o más de los siguientes: 'agent', 'admin', 'supervisor')

Puedes configurar tu IdP para proporcionar otros atributos o reclamaciones en la aserción SAML. Por el momento, vamos a centrarnos en el atributo obligatorio de roles. Para una lista completa, incluyendo las reclamaciones opcionales, consulta la documentación [aquí](enlace). Puedes tener otros casos de uso para agregar atributos adicionales, por lo que es recomendable revisar la lista completa que Flex SSO puede aceptar para no introducir un atributo que ya esté asignado en Flex.

Los datos del usuario enviados a Flex desde el Proveedor de Identidad se almacenan en los atributos del Trabajador de TaskRouter. Los atributos del Trabajador creados para el usuario que ha iniciado sesión se actualizan en cada inicio de sesión SSO exitoso, por lo que cualquier cambio en los datos del usuario realizado en tu IdP también se reflejará como atributos del trabajador.

Por lo tanto, la gestión de los usuarios de Flex y sus capacidades debe realizarse dentro de tu IdP. Cómo se hace eso depende del IdP.

La mayoría admite la gestión de usuarios a través de su propio almacén de datos de usuarios, LDAP (Protocolo Ligero de Acceso a Directorios), AD (Active Directory) y otros medios. Ahí es donde se deben gestionar tus usuarios. Mapear los datos del usuario a las reclamaciones SAML 2.0 está fuera del alcance de este curso, pero puedes leer los conceptos básicos en [esta página](enlace), donde se proporciona la configuración para varios proveedores.

Con eso en mente, veamos un aspecto de cómo se utilizan los datos de un IdP en Flex.

## Actualización de roles de usuario

Si has iniciado sesión en Flex como Joe Owling, cierra la sesión de la interfaz de usuario de Flex. En otra pestaña, busquemos a Joe Owling en la lista de trabajadores en el espacio de trabajo de TaskRouter para tu proyecto de Flex. Para encontrar esa lista, visita el panel de control de TaskRouter.

Eso debería llevarte a esta página. Desde allí, sigue el enlace a "Flex Task Assignment", que te llevará a la página de resumen.

![[Pasted image 20250224211515.png]]


Si no ves a Joe Owling en la lista de trabajadores recientes, haz clic en "Ver todos los trabajadores" o en el elemento "Trabajadores" en el panel de navegación izquierdo. Cuando finalmente llegues a la página de Joe, verás algo como lo siguiente.
![[Pasted image 20250224211526.png]]

Como puedes ver en la sección de atributos, los roles que tiene Joe solo incluyen lo que hayas establecido la última vez. En este caso, solo se seleccionó "agent" en el último inicio de sesión.

Pero cuando inicies sesión nuevamente con SSO y establezcas diferentes roles, los verás reflejados aquí cuando actualices la página de Joe.

![[Pasted image 20250224211541.png]]


Por ejemplo, si seleccionas "admin" y "supervisor", verás que los roles se actualizarán para incluir "supervisor" además de "admin".
![[Pasted image 20250224211552.png]]
Por lo tanto, para modificar los roles de usuario, debes cambiar la declaración de atributos que genera tu IdP como parte de la aserción SAML en el inicio de sesión exitoso al IdP.

Como se mencionó antes, otros atributos, incluidos los personalizados que no son específicamente necesarios para Flex, pueden agregarse a la declaración. Por ejemplo, el "contact_uri" para un usuario de Flex puede establecerse a través de datos proporcionados por un IdP.

Vale la pena señalar que otros atributos del trabajador, como la capacidad del canal de tareas o las propiedades de Flex Insights, también pueden establecerse a través de la declaración de atributos.

Nuevamente, la documentación de configuración de SSO de Twilio tiene una lista completa de atributos disponibles que pueden gestionarse de esta manera.

El mapeo de los datos del usuario dentro de cualquier IdP a la declaración de atributos de una aserción SAML variará según las especificaciones del IdP utilizado. Sin embargo, si comprendes el resultado deseado, podrás trabajar con el IdP que estás utilizando para generar ese resultado.

Por ejemplo, si quisieras establecer la capacidad del canal de chat de un agente en 3, entonces necesitarías configurar el IdP para agregar el siguiente XML a la declaración de atributos de la aserción SAML:

```xml
<saml:Attribute Name="channel.chat.capacity"
    NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic">
    <saml:AttributeValue xsi:type="xs:double">3</saml:AttributeValue>
</saml:Attribute>
```

## Uso de usuarios de la consola para iniciar sesión en Flex

Vale la pena tomar un momento para asegurarte de entender la distinción entre los usuarios de Flex aprovisionados a través de SSO y los usuarios de Flex aprovisionados a través de la consola web de Twilio.

Es posible que hayas notado, si revisas la página de gestión de usuarios de tu proyecto de Flex, que puedes agregar otros usuarios al proyecto. Esta forma de agregar usuarios es realmente solo para colegas que están trabajando en el desarrollo o administración del proyecto o tienen autoridad de facturación.

Los usuarios con perfiles de desarrollador o administrador pueden iniciar sesión tanto en la interfaz de usuario de Flex como en la consola, utilizando sus credenciales de Twilio. Ten en cuenta que se les asignaría automáticamente el rol de 'admin', y eso no se puede actualizar. Los usuarios de facturación solo pueden iniciar sesión en la consola y no podrían acceder a Flex.

Si bien puede ser útil agregar rápidamente miembros del equipo de esta manera, especialmente durante el desarrollo y las pruebas, esta no es la forma recomendada de agregar usuarios finales de tu aplicación Flex. Deben gestionarse en tu IdP e iniciar sesión a través de SSO.

## Resumen

En esta lección vimos:

- Cómo Flex utiliza una aserción SAML para crear o actualizar usuarios de Flex
- Dónde gestionar los usuarios de Flex y sus atributos de trabajador
- Otros atributos que pueden gestionarse a través de un IdP y el inicio de sesión SSO

Con eso, has completado este curso. ¡Bien hecho!

Ahora estás listo para configurar SSO con el IdP de tu elección en tu organización.
```