# Flujo de inicio de sesión

Para recapitular, hemos visto que Flex puede configurarse para habilitar el SSO (Inicio de Sesión Único) utilizando cualquier IdP (Proveedor de Identidad) que admita el intercambio de datos de autenticación y autorización para proveedores de servicios mediante SAML.

Ahora, profundicemos en algunos detalles sobre lo que se envía entre el Proveedor de Servicios, en nuestro caso Flex, y el IdP.

Para ayudar a comprender el intercambio de datos SAML entre Flex y un IdP, puede ser muy útil instalar extensiones en las herramientas de desarrollo de tu navegador. A continuación, se muestran enlaces a un par de extensiones que puedes utilizar:

- **SAML Tracer** - Firefox
- **SAML Chrome Panel**

También puedes explorar muchas solicitudes y respuestas SAML aquí. Sin embargo, dado que el intercambio de datos entre las partes está codificado en base64URL y comprimido, necesitarás realizar algunos pasos adicionales para ver el XML real. Será divertido e instructivo, pero en el siguiente tutorial veremos los datos utilizando el plugin SAML Chrome Panel.

Esta lección es solo una breve descripción general de alto nivel del SSO en Flex. No necesitas saber todo esto para configurar el SSO, pero un poco de conocimiento te ayudará mucho a configurar el SSO con Proveedores de Identidad del mundo real.

![[Pasted image 20250224210845.png]]

Primero, si aún estás conectado a Flex, cierra la sesión de la cuenta de Joe Owling.

Desde Flex, haz clic en el elemento del perfil de usuario en la navegación superior y selecciona "Cerrar sesión".

Esto te llevará a la página de inicio de sesión predeterminada de Flex que puedes ver a continuación.

Esta es la página de inicio de sesión estándar de Flex. Puedes notar el enlace 'Iniciar sesión con Twilio' en la parte inferior de la página. Ese enlace no es un enlace de inicio de sesión SSO. Ese enlace es para iniciar sesión con tu nombre de usuario y contraseña de la consola de Twilio.

Puedes agregar otros usuarios a tu proyecto de Flex que puedan iniciar sesión tanto en la consola web como en la interfaz de usuario de Flex, pero esa no es la forma recomendada de agregar usuarios adicionales al sistema. Profundizaremos en eso más adelante.

Por ahora, vamos a usar SSO para iniciar sesión nuevamente, lo que significa usar el formulario que ves a la derecha. Pero antes de hacerlo, asegúrate de tener algo como el SAML Chrome Panel instalado y de tener los detalles de tu dominio de tiempo de ejecución.

![[Pasted image 20250224210903.png]]
![[Pasted image 20250224210923.png]]

Tu dominio de tiempo de ejecución se puede encontrar en la página de configuración de SSO. También puedes ver la URL completa de inicio de sesión SSO y un enlace "Iniciar sesión con SSO", por si acaso.

En resumen, si terminas en la página de inicio de sesión estándar de Flex que se muestra arriba, todo lo que necesitas ingresar en el campo de texto es el dominio de tiempo de ejecución. En la captura de pantalla de la izquierda, puedes ver que el dominio es "maize-turtle-3606". Si estás siguiendo estos pasos en tu propio proyecto de Flex, el dominio será diferente.

Justo antes de copiar y pegar tu dominio de tiempo de ejecución en el campo de texto del formulario de inicio de sesión, si no has instalado una extensión de herramientas de desarrollo para ver la solicitud y respuesta SAML, hazlo ahora.

Si has instalado la extensión, abre tus herramientas de desarrollo y asegúrate de que la pestaña SAML esté seleccionada.

Esta captura de pantalla muestra cómo se verá si estás usando SAML Chrome Panel.

Una vez que estés listo, haz clic en el botón de lanzamiento y serás redirigido al formulario de inicio de sesión del IdP nuevamente.

![[Pasted image 20250224210937.png]]
![[Pasted image 20250224210954.png]]

Como puedes ver, Twilio te ha redirigido a la página de inicio de sesión del IdP que configuraste en la configuración de SSO, específicamente "https://idp-9351.twi.io/sam/sso", y también ha pasado un parámetro de cadena de consulta llamado "SAMLRequest".

El valor del parámetro SAMLRequest es una representación codificada en base64 y comprimida del XML de la solicitud SAML, que puedes ver decodificado y descomprimido en el panel derecho.

El siguiente fragmento muestra el XML de la solicitud SAML:

```xml
<samlp:AuthnRequest xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
    xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion" ID="ONELOGIN_9c756c0f-f07e-47ce-8704-129a38d0c63b" Version="2.0" IssueInstant="2020-11-19T14:49:25Z" ProviderName="Twilio" Destination="https://idp-9351.twil.io/saml/sso" ProtocolBinding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" AssertionConsumerServiceURL="https://iam.twilio.com/v1/Accounts/AC********************************/saml2">
    <saml:Issuer>https://iam.twilio.com/v1/Accounts/AC********************************/saml2/metadata</saml:Issuer>
    <samlp:NameIDPolicy Format="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress" AllowCreate="true" />
    <samlp:RequestedAuthnContext Comparison="exact">
        <saml:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:Password</saml:AuthnContextClassRef>
    </samlp:RequestedAuthnContext>
</samlp:AuthnRequest>
```

Algunas cosas que vale la pena notar aquí son:

- La URL: "AssertionConsumerServiceURL", que es una URL de la API de IAM de Twilio.
- El "samlp:NameIDPolicy", que especifica que la respuesta SAML debe contener un correo electrónico.
- Y "samlp:RequestedAuthnContext> saml:AuthnContextClassRef" especifica que se debe presentar al usuario un método de autenticación por contraseña.

Ahora, debemos ser claros, nuestro IdP falso no presenta una entrada de contraseña al usuario. Simplemente estamos omitiendo eso por completo en nuestro IdP. No estamos sugiriendo que eso sea un escenario realista.

Adelante, selecciona algunos roles del menú de selección de roles y haz clic en "Iniciar sesión" para ver qué sucede a continuación.

![[Pasted image 20250224211141.png]]

Como puedes ver, Joe ha iniciado sesión y puedes ver la respuesta SAML del IdP a la derecha. Pero espera un momento:

¿Qué acaba de pasar?

Aquí es donde se pone interesante. Si recuerdas, estábamos viendo un formulario para nuestro IdP, que se veía así a la derecha.

Hicimos clic en "Iniciar sesión", el formulario se envió por POST al IdP. Luego, el IdP hizo su trabajo.

Entonces, si miras el panel SAML de Chrome arriba, aparentemente de la nada, una respuesta SAML se envió por POST a la URL del servicio de consumidor de aserciones, que es la URL de la API de IAM de Twilio para el inicio de sesión SAML 2.0.

¿Cómo funcionó eso? Funcionó gracias a algo llamado SAML 2.0 con enlace HTTP POST.

![[Pasted image 20250224211155.png]]

**SAML 2.0 con enlace HTTP POST**

La versión de SAML 2.0 que Twilio admite es lo que se conoce como SAML 2.0 con enlace HTTP POST.

Recuerda cuando hiciste clic en "Iniciar sesión". Tu navegador envió el formulario de inicio de sesión falso y la respuesta del IdP fue otro formulario HTML con un campo de entrada oculto llamado, apropiadamente, "SAMLResponse". Ese formulario se envió automáticamente, por el USER-AGENT (tu navegador) utilizando Javascript incrustado.

Si tuvieras que echar un vistazo al formulario que devuelve el IdP, se vería algo así:

```html
<form method="post" name="hiddenform" action="https://iam.twilio.com/v1/Accounts/AC****************************/saml2">
    <input type="hidden" name="SAMLResponse" value="PHNhbW...">
    <input type="hidden" name="RelayState" value="A....">
</form>
<script language="javascript" type="text/javascript">
    window.setTimeout(function(){document.forms[0].submit();}, 0);
<script>
```

El campo de entrada oculto SAMLResponse es la aserción SAML codificada y firmada del IdP.

Es posible que hayas notado el campo de entrada oculto RelayState desde la página de inicio de sesión falsa del IdP. Estos son datos proporcionados por el Proveedor de Servicios (Flex) en la solicitud SAML inicial. Como el inicio de sesión es un proceso asíncrono, el RelayState se devuelve a Flex sin modificaciones y se utiliza para proporcionar contexto sobre la solicitud de inicio de sesión.

Lo último que debes notar en el formulario es el bloque de script que envía inmediatamente el formulario a la URL de IAM de Twilio (https://iam.twilio.com/v1/Accounts/AC****************************/saml2"). Lo hace estableciendo un tiempo de espera para la ejecución del script después de 0 milisegundos.

La SAMLResponse incrustada en el formulario que se envía automáticamente es lo que se utiliza para establecer a Joe en un estado de inicio de sesión y, si es necesario, establecer o actualizar datos adicionales sobre Joe como atributos de trabajador de TaskRouter.

No mostraremos la respuesta SAML decodificada completa incrustada en el formulario aquí, ya que es bastante larga, pero a continuación hay un par de fragmentos que vale la pena ver.

En primer lugar, si recuerdas en la solicitud SAML de Twilio, había un "samlp:NameIDPolicy", lo que significa que la respuesta debe contener un "saml:NameID" y el formato debe ser una dirección de correo electrónico. Esta es la parte de la respuesta que satisface ese requisito.

```xml
<saml:Subject>
    <saml:NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress">joe.owling@example.com
    </saml:NameID>
...
</saml:Subject>
```

A continuación, echemos un vistazo a la declaración de atributos. Aquí podemos ver que la declaración contiene todos los elementos de datos necesarios para completar un inicio de sesión SSO con Flex. Echa un vistazo a la documentación aquí.

En el fragmento a continuación puedes ver:

- email
- roles
- full_name

Los roles que ves en el XML reflejarán lo que se haya elegido en el formulario de inicio de sesión falso. En este caso, se eligieron "agent" y "supervisor".

```xml
<saml:AttributeStatement xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <saml:Attribute Name="email" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic">
        <saml:AttributeValue xsi:type="xs:string">joe.owling@example.com
        </saml:AttributeValue>
    </saml:Attribute>
    <saml:Attribute Name="roles" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic">
        <saml:AttributeValue xsi:type="xs:string">agent
        </saml:AttributeValue>
        <saml:AttributeValue xsi:type="xs:string">supervisor
        </saml:AttributeValue>
    </saml:Attribute>
    <saml:Attribute Name="full_name" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic">
        <saml:AttributeValue xsi:type="xs:string">Joe Owling
        </saml:AttributeValue>
    </saml:Attribute>
</saml:AttributeStatement>
```

En este punto, es posible que te hayas preguntado: "¿Cómo Joe Owling se convirtió en un usuario, y qué significa que tenga algunos roles, inmediatamente sin haber hecho nada?".

Si te has estado haciendo esas preguntas, es algo bueno porque a continuación vamos a ver la provisión de usuarios en Flex.

Pero antes de terminar, vale la pena recordar algo. Esta lección pasó rápidamente por algunos detalles, pero espero que haya sido razonablemente clara. Sin embargo, debes saber que entender esto no es un requisito para configurar SSO en Flex. Como vimos en una lección anterior, configurar SSO en Flex es puramente una configuración en el lado de Twilio.

## Resumen

En esta sección vimos:

- Cómo se ve una solicitud y respuesta SAML 2.0
- Cómo rastrear el flujo de solicitudes y respuestas entre el proveedor de servicios y el proveedor de identidad
- La variante específica de SAML 2.0 que Twilio utiliza, es decir, SAML 2.0 con enlace HTTP POST

A continuación, veremos la gestión de usuarios para proyectos de Flex y cómo la declaración de atributos que vimos arriba se utiliza en la provisión o actualización de usuarios.
