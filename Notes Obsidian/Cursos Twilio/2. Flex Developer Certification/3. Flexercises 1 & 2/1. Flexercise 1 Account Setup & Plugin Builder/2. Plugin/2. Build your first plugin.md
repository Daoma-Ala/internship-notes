Estás manteniendo una solución de Centro de Contacto para OwlCorp. Y has notado que, a veces, los agentes olvidan cambiar su estado después de un descanso o cuando comienza su turno. Entonces esperan y esperan, pero no reciben nuevas llamadas.

Porque no están en un estado disponible.

El lienzo predeterminado ya muestra esta información:
![[Pasted image 20250209223649.png]]

Pero hagamos que la advertencia del estado de la actividad sea un poco más destacada, para que nuestros agentes realmente la tomen en cuenta.

Algo como esto debería funcionar:
![[Pasted image 20250209223759.png]]

## Crear un plugin vacío

Usa el **Flex Plugins CLI** que instalamos en el módulo anterior para crear un plugin vacío.

### Crear un nuevo plugin

```sh
twilio flex:plugins:create plugin-state-warning --install
```

El parámetro `--install` instala automáticamente todas las dependencias de NPM.

Ahora, si miras dentro del directorio del plugin que creó el **Plugin Builder**, deberías ver algo como esto:

```sh
$ cd plugin-state-warning/
$ ls -l
-rw-r--r--     1     1165  README.md
-rw-r--r--     1      221  jest.config.js
drwxr-xr-x  1143    36576  node_modules
-rw-r--r--     1  1532340  package-lock.json
-rw-r--r--     1      359  package.json
drwxr-xr-x     4      128  public
drwxr-xr-x     6      192  src
-rw-r--r--     1      220  webpack.config.js
-rw-r--r--     1      243  webpack.dev.js
```

El directorio `src/` contiene el código fuente de tu plugin. Cuando el plugin se compile, solo el código de este directorio será incluido.

```sh
$ ls -l src/
-rw-r--r--     1  1284  StateWarningPlugin.js
drwxr-xr-x     4   128  components
-rw-r--r--     1   142  index.js
drwxr-xr-x     4   128  states
```

El archivo `src/StateWarningPlugin.js` es el archivo principal del plugin. Vamos a echarle un vistazo:

```javascript
import React from 'react';
import { VERSION } from '@twilio/flex-ui';
import { FlexPlugin } from '@twilio/flex-plugin';

import CustomTaskListContainer from './components/CustomTaskList/CustomTaskList.Container';
import reducers, { namespace } from './states';

const PLUGIN_NAME = 'StateWarningPlugin';

export default class StateWarningPlugin extends FlexPlugin {
  constructor() {
    super(PLUGIN_NAME);
  }

  /**
   * Este código se ejecuta cuando tu plugin se inicia.
   * Úsalo para modificar cualquier componente de la UI o adjuntarlo al framework de acciones.
   *
   * @param flex { typeof import('@twilio/flex-ui') }
   * @param manager { import('@twilio/flex-ui').Manager }
   */
  async init(flex, manager) {
    this.registerReducers(manager);

    const options = { sortOrder: -1 };
    flex.AgentDesktopView.Panel1.Content.add(
      <CustomTaskListContainer key="StateWarningPlugin-component" />,
      options
    );
  }

  /**
   * Registra los reducers del plugin
   *
   * @param manager { Flex.Manager }
   */
  registerReducers(manager) {
    if (!manager.store.addReducer) {
      // eslint-disable-next-line
      console.error(
        `Necesitas FlexUI > 1.9.0 para usar Redux integrado; actualmente estás en ${VERSION}`
      );
      return;
    }

    manager.store.addReducer(namespace, reducers);
  }
}
```

Puede parecer un poco intimidante, pero incluye mucho código de ejemplo que no necesitaremos.

- Hay un ejemplo de un componente personalizado cargado en la **línea 5** y luego agregado al escritorio del agente en las **líneas 25-29**.
- Luego, en las **líneas 37-47**, se muestra cómo registrar reducers de Redux.

Más adelante eliminaremos parte de este código.

---

## Ejecutar el plugin localmente

Cuando creaste tu plugin, se instaló una versión local de la **Flex UI** como una de las dependencias. Puedes ejecutar esa versión local de Flex UI para probar tu plugin.

El siguiente screencast demuestra cómo hacerlo.
![[Pasted image 20250209224358.png]]
![[Pasted image 20250209224415.png]]

---
## Iniciar sesión
![[Pasted image 20250209224705.png]]
Al abrir la **Flex UI**, es posible que primero se te pida iniciar sesión. Veamos cómo hacerlo.

### Seleccionar el proyecto correcto
![[Pasted image 20250209224719.png]]
Como primer paso, abre una nueva pestaña en tu navegador y dirígete a tu [**Twilio Console**](https://www.twilio.com/console).

Luego, asegúrate de que el [proyecto](https://support.twilio.com/hc/en-us/articles/360011132374-Getting-Started-with-Twilio-Projects-and-Subaccounts) que creaste para este **Flexercise** esté seleccionado.

Si eres miembro de múltiples proyectos y tienes otro proyecto abierto en este momento, [cambia](https://support.twilio.com/hc/en-us/articles/360011177133-View-and-Create-New-Projects-in-Twilio-Console) al proyecto que estás usando para este **Flexercise**. Esto se puede hacer desde el menú desplegable en la parte superior izquierda.

### Iniciar sesión con Twilio
![[Pasted image 20250209224833.png]]
Después, regresa a la pantalla de inicio de sesión de **Flex UI** y haz clic en **"Login with Twilio"** en la parte inferior de la pantalla.

---

### Explicación

Quizás te preguntes qué es el mensaje sobre el **Runtime Domain**.

**Flex** usa **Inicio de Sesión Único (Single Sign-On, SSO)** de forma predeterminada para autenticar a los usuarios individuales. El **Runtime Domain** es un identificador de tu instancia de **Flex** que permite a la versión alojada de **Flex** recuperar tu configuración de **SSO**.

Cubriremos el **Inicio de Sesión Único** en uno de nuestros próximos **Flexercises**.

Por ahora, omitiremos el **SSO** y iniciaremos sesión con tu cuenta de **Twilio Console**.

Esto es exactamente lo que hiciste al hacer clic en el enlace **"Login with Twilio"**.

---

## Agregar la funcionalidad deseada

### Eliminar el código innecesario

Antes de comenzar a agregar funcionalidad, eliminemos todo lo que no necesitaremos. Eliminemos todo el código de ejemplo descrito anteriormente.

Reemplaza el contenido de tu archivo principal del plugin con lo siguiente:

```javascript
import React from 'react';
import { FlexPlugin } from '@twilio/flex-plugin';

const PLUGIN_NAME = 'StateWarningPlugin';

export default class StateWarningPlugin extends FlexPlugin {
  constructor() {
    super(PLUGIN_NAME);
  }

  async init(flex, manager) {
    // tu código va aquí
  }
}
```

Ahora es mucho más simple.

Solo importamos la clase `FlexPlugin` y luego creamos la clase de nuestro plugin que la extiende.

El método `init` del plugin es donde ocurrirá toda la acción.

---

### Agregar la funcionalidad necesaria

Ahora agreguemos la funcionalidad que necesitamos.

Recuerda, este es el producto final que queremos lograr:
![[Pasted image 20250209224952.png]]

---

## Construcción del Plugin

Para construir esto, necesitamos 2 cosas:

### 1. Obtener la disponibilidad del agente

### 2. Mostrar una advertencia si el agente no está disponible

### ¿Cómo sabemos si un agente está disponible?

El enrutamiento inteligente de tareas a agentes en **Flex** se basa en **TaskRouter**.

Cada agente en **Flex** está representado por un **Worker** en **TaskRouter**, y la disponibilidad del **Worker** para recibir nuevas tareas está determinada por su **Activity**.

Si accedes a tu **Twilio Console**, en la sección **TaskRouter**, y abres el espacio de trabajo **Flex Task Assignment** (que se creó automáticamente cuando inicializaste tu proyecto de **Flex**), verás las cuatro **Actividades** predeterminadas:

![[Pasted image 20250209225219.png]]
Cada actividad tiene un atributo de **Disponibilidad** que decide si un **Worker** puede o no recibir nuevas tareas cuando está en esa actividad.

De las cuatro actividades predeterminadas, solo la actividad llamada **"Available"** permitirá que un **Worker** reciba nuevas tareas. Sin embargo, puedes definir tus propias actividades personalizadas o modificar las existentes.

---

## Usar esta información en nuestro plugin

Ahora usaremos este conocimiento en nuestro **plugin**.

Agregaremos un nuevo **componente** que recuperará la actividad del **Worker** y su valor de **disponibilidad**, obteniendo esta información de los `props` que se le pasan automáticamente.

Al agregar un **componente personalizado**, podemos especificar una condición con `if`, de modo que el componente solo se agregue a la UI si se cumple esa condición.

```javascript
flex.NoTasksCanvas
  .Content
  .add(
    <div style={{ color: "red", padding: 20 }} key="warning">
      You are not available to receive tasks!
    </div>,
    {
      if: props => props.worker.activity.available === false
    });
```

Agrega el comando anterior dentro del método `init` de tu plugin (línea 12) y guarda los cambios.

---

## Desplegar el Plugin

Ahora puedes probar el **plugin** usando la versión local de **Flex UI**.

Una vez que hayas confirmado que el **plugin** funciona como se espera, puedes desplegarlo usando el **Twilio CLI**.

===video===


---

## Comandos de Plugins CLI utilizados en el screencast

Para tu conveniencia, aquí están los comandos utilizados en el screencast anterior:

```bash
# Iniciar el plugin localmente
twilio flex:plugins:start

# Construir, desplegar y crear una nueva versión mayor del plugin
twilio flex:plugins:deploy --major --changelog "Adding state warning" --description "State warning plugin"

# Crear una configuración y un lanzamiento con la nueva versión del plugin
twilio flex:plugins:release --plugin plugin-state-warning@1.0.0 --name "State Warning" --description "Displays state warning for agents"
```

---

### Al desarrollar un complemento, puede crearlo y probarlo localmente sin tener que implementarlo primero.

verdad

El generador de complementos instala una versión local de Flex UI como una de sus dependencias. Esta puede usarse para probar el complemento localmente sin tener que implementarlo en Twilio Assets.

### 