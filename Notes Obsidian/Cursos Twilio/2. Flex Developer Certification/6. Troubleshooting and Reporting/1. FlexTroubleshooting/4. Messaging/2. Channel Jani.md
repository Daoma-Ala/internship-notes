
# Channel Janitor: Limpieza automática de recursos de conversación

En el módulo anterior, describimos el mecanismo para crear sesiones de **Proxy** y canales de **Chat** cuando comienza una conversación de mensajería.

Cuando la conversación termina después de que el agente presiona el botón **End Chat**, ocurren dos cosas:

1. **El canal de Chat se marca como inactivo**.
2. **La sesión de Proxy se elimina**.

Estos eventos son activados por defecto por el **frontend**, y la interfaz de usuario de Flex debe estar abierta para que esto suceda.

Sin embargo, lo que a veces ocurre es que el agente cierra la pestaña del navegador con la interfaz de usuario de Flex mientras aún hay alguna tarea activa. Si la tarea permanece activa durante la noche, podría agotar el tiempo de espera (después de 24 horas por defecto). Y si eso sucede, la tarea se elimina.

Esto elimina la tarea de la lista de tareas del agente. Sin embargo, como la interfaz de usuario estaba cerrada cuando esto ocurrió, no pudo activar las dos acciones de limpieza mencionadas anteriormente, y tanto la sesión de Proxy como el canal de Chat persisten.

---

## ¿Por qué es esto un problema?

Imagina que el mismo cliente escribe nuevamente. La sesión de Proxy para ese número de teléfono sigue activa, por lo que Proxy agrega este mensaje a la sesión existente, Chat lo agrega al canal existente y se envía para mostrarse en la interfaz de usuario del agente. Pero la tarea asociada con la conversación original fue eliminada y no hay una representación visual de ella en la interfaz de usuario del agente. Por lo tanto, el mensaje no se muestra en ningún lugar y parece estar perdido.

---

## Soluciones

Hay varias formas de resolver este problema:

### 1. **Habilitar Channel Janitor**
   - Se puede abordar automáticamente habilitando **Channel Janitor** a nivel de **Flex Flow**. Esto delega la responsabilidad de la limpieza de recursos al servicio backend **Channel Janitor**, que opera independientemente de la interfaz de usuario de Flex.
   - Una vez habilitado, Channel Janitor monitorea los eventos de **TaskRouter** (que indican que una tarea ha sido completada o ha agotado el tiempo de espera) y limpia los recursos asociados con cada conversación según sea necesario.
   - Para habilitar Channel Janitor, simplemente establece la propiedad `JanitorEnabled` del **Flex Flow** en `true`:

     ```json
     {
       "JanitorEnabled": true
     }
     ```

### 2. **Solución manual (eliminación directa)**
   - Si este no es un problema recurrente, también se puede abordar manualmente eliminando la sesión de Proxy y el canal de Chat desde la **Consola de Twilio** (aunque para eliminar el canal de Chat, es posible que necesites usar el **API Explorer**).

### 3. **Solución manual (marcar como inactivo)**
   - Otra solución manual un poco más compleja es utilizar el mismo mecanismo que Flex usa internamente y simplemente establecer el estado del canal de Chat como `"INACTIVE"`. Esto limpiará automáticamente la sesión de Proxy asociada.
   - Esta es una solución más elegante que eliminar el canal, ya que te permite mantener el canal de Chat, por ejemplo, si necesitas acceder al historial de la conversación.

   **Notas importantes:**
   - La propiedad `attributes` del canal debe actualizarse como un objeto JSON completo. Por lo tanto, normalmente querrás leer su valor primero, modificar el valor de `state` y luego enviar el objeto completo nuevamente (puedes recordar que usamos un enfoque similar para modificar el **Objeto de Configuración** anteriormente en este curso).
   - Para activar el mecanismo de limpieza del backend, necesitarás incluir el encabezado `X-Twilio-Webhook-Enabled`. Consulta [esta página](enlace) para una explicación detallada de por qué esto es necesario.

   **Ejemplo de código (usando `jq`):**

   ```bash
   curl -X POST https://chat.twilio.com/v2/Services/{ServiceSID}/Channels/{ChannelSID} \
        -u "ACCOUNT_SID:AUTH_TOKEN" \
        -H "X-Twilio-Webhook-Enabled: true" \
        -d "Attributes=$(curl -s https://chat.twilio.com/v2/Services/{ServiceSID}/Channels/{ChannelSID} \
                          -u "ACCOUNT_SID:AUTH_TOKEN" | jq '.attributes | .state = "INACTIVE"')"
   ```

   > **Nota:** Este fragmento de código utiliza un procesador JSON de terceros llamado `jq`, que es posible que necesites instalar por separado.

---

## Recomendación

Si enfrentas repetidamente sesiones obsoletas en tu instancia de Flex, usar **Channel Janitor** es la solución recomendada. No hay muchas desventajas en esto, y la razón principal por la que no está habilitado por defecto es que algunos proyectos de Flex dependen del comportamiento heredado.

---

A continuación, hablemos sobre cómo recuperar y/o reconectar tu flujo de mensajería si algo le sucede.
