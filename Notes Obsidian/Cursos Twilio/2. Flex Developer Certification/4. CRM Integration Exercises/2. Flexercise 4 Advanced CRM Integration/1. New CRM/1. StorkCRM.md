# Nota sobre DuckyCRM y StorkCRM

DuckyCRM nos facilitó las cosas, ya que lo único que tuvimos que hacer fue incrustarlo directamente en el `CRMContainer`. Sin embargo, existen CRMs que no permiten ser incrustados de esa manera, como es el caso de StorkCRM. Pero retrocedamos un poco...

## Cómo el `CRMContainer` en Flex incrusta el CRM

El `CRMContainer` en Flex incrusta el CRM mediante un `iframe`. Un `iframe` es una etiqueta HTML que define un marco en línea. Este es el mecanismo de HTML para incrustar un documento o un sitio web dentro de otro.

### Riesgos de seguridad y restricciones

Sin embargo, esto también puede representar un [riesgo de seguridad](https://en.wikipedia.org/wiki/Clickjacking), por lo que los navegadores web proporcionan medios para que un sitio web especifique si permite ser incrustado dentro de otro documento. Hay dos cabeceras HTTP que controlan este comportamiento:

- **X-Frame-Options**: Un mecanismo más antiguo con amplio soporte en navegadores.
- **Content-Security-Policy's frame-ancestors directive**: Un mecanismo más nuevo que obsoleta `X-Frame-Options` en navegadores que lo soportan.

### StorkCRM y sus restricciones

StorkCRM no permite que sus páginas sean incrustadas en otros sitios web y, para ello, implementa ambos mecanismos descritos anteriormente. Específicamente, devuelve estas dos cabeceras con cada solicitud:

```http
x-frame-options: deny
content-security-policy: frame-ancestors 'none'
```

StorkCRM está disponible en:

```
https://storkcrm-3329-dev.twil.io/index
```

Puedes intentar abrir el enlace en una ventana del navegador y funcionará.

### Intentando incrustar StorkCRM en `CRMContainer`

Si intentas incrustar StorkCRM usando el `CRMContainer`, siguiendo lo que hicimos con DuckyCRM, podrías usar algo como:

```javascript
async init(flex, manager) {
  flex.CRMContainer.defaultProps.uri =
    'https://storkcrm-3329-dev.twil.io/index';
}
```

Si abres este plugin, recibirás un error similar a:

```
Refused to frame 'https://storkcrm-3329-dev.twil.io/' because an ancestor violates the following Content Security Policy directive: "frame-ancestors 'none'".
```

### Inspeccionando las cabeceras HTTP

Si deseas verificar las cabeceras HTTP en la respuesta del servidor, puedes inspeccionar la respuesta de la página en tu navegador o usar un comando como `curl`.

#### Paso 1: Abrir la página en el navegador

Por ejemplo, en Chrome, abre la página de índice de Stork CRM mencionada anteriormente, abre las herramientas de inspección (F12) y cambia a la pestaña de Red.

#### Paso 2: Inspeccionar las cabeceras de respuesta

Recarga la página y selecciona el archivo índice en las herramientas de desarrollo. Puedes ver las cabeceras de respuesta, incluyendo los campos `x-frame-options` y `content-security-policy` que impiden que este contenido sea incrustado en un `iframe`.

#### Paso 3: Usar la línea de comandos

```bash
$ curl -D - https://storkcrm-3329-dev.twil.io/index -o /dev/null
HTTP/2 200
content-type: text/html; charset=utf8
content-length: 5668
x-frame-options: deny
content-security-policy: frame-ancestors 'none'
vary: Accept-Encoding
x-shenanigans: none
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
```

Alternativamente, puedes usar `curl` para realizar la solicitud y mostrar las cabeceras de respuesta.

## Resumen

Ahora puedes mostrar las cabeceras HTTP utilizando un navegador web o la línea de comandos.

# Componentes Personalizados

En el ejercicio anterior (#3), pudimos incrustar directamente DuckyCRM en Flex usando un `iframe`, pero StorkCRM no permitirá ese tipo de tratamiento.

Para abordar las restricciones de incrustación, obtendremos los datos de StorkCRM en formato JSON. Utilizaremos componentes personalizados de React que renderizarán las piezas individuales del perfil del cliente. Luego, colocaremos esos componentes en la interfaz de usuario de Flex.

## Obtención de Datos del CRM

Por último, pero no menos importante, abordaremos un tema adicional: la obtención dinámica de datos del CRM desde el propio plugin de Flex.

Aunque seguiremos obteniendo el perfil inicial del cliente desde el IVR, también permitiremos la obtención de datos adicionales bajo demanda desde el plugin de Flex.

### Caso de Uso

StorkCRM almacena dos preguntas de seguridad para cada perfil de cliente. Nuestros agentes pueden usar estas preguntas para verificar que están hablando con la persona correcta.

Agregaremos la funcionalidad de obtener estas preguntas de seguridad bajo demanda en nuestro plugin. Además, construiremos una función proxy que el plugin utilizará para obtener estos datos del CRM.

### Arquitectura de Alto Nivel

La arquitectura de alto nivel se verá así:

1. **Plugin de Flex**: 
   - Contiene componentes personalizados de React para mostrar la información del cliente.
   - Realiza solicitudes bajo demanda para obtener datos adicionales (como las preguntas de seguridad) desde el CRM.

2. **Función Proxy**:
   - Actúa como intermediario entre el plugin de Flex y StorkCRM.
   - Maneja las solicitudes de datos y devuelve la información en formato JSON.

3. **StorkCRM**:
   - Almacena los perfiles de los clientes, incluyendo las preguntas de seguridad.
   - Proporciona los datos a través de una API que el proxy consume.

### Flujo de Trabajo

4. **Inicialización**:
   - El plugin de Flex obtiene el perfil básico del cliente desde el IVR.
   - Los componentes de React renderizan la información inicial.

5. **Solicitud Bajo Demanda**:
   - Cuando el agente necesita verificar la identidad del cliente, el plugin solicita las preguntas de seguridad a través de la función proxy.
   - La función proxy realiza una solicitud a StorkCRM y devuelve las preguntas de seguridad en formato JSON.

6. **Renderizado**:
   - Los componentes de React actualizan la interfaz de usuario para mostrar las preguntas de seguridad.

### Beneficios

- **Flexibilidad**: Al obtener datos bajo demanda, podemos reducir la carga inicial y mejorar el rendimiento.
- **Seguridad**: Al usar una función proxy, podemos controlar y gestionar mejor las solicitudes al CRM.
- **Experiencia del Agente**: Los agentes tienen acceso a información crítica en tiempo real, lo que mejora la eficiencia y la precisión en la verificación de clientes.

Este enfoque nos permite superar las limitaciones de incrustación y proporcionar una experiencia más robusta y segura para nuestros agentes.

![[Pasted image 20250211095101.png]]

> **Solicitud de IVR**
	Las solicitudes del IVR se envían directamente a StorkCRM, como antes.
> **Solicitudes del complemento Flex**
	Las solicitudes iniciadas desde el complemento Flex ahora son manejadas por una función proxy que las pasa a StorkCRM.
> **Response**
	StorkCRM devuelve datos de perfil en formato JSON. Luego, el complemento Flex procesa estos datos mediante componentes personalizados.

