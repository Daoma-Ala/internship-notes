
# Integración de Flex dentro de un CRM

En esta sección, integraremos Flex dentro de un CRM. Esto puede ser útil si tu CRM no admite ninguna otra forma de integración o si toda la funcionalidad que necesitan tus agentes ya la proporciona el CRM y solo deseas agregar la funcionalidad del centro de contacto sobre eso.

También presentaremos brevemente las llamadas salientes. Hasta ahora, solo hemos visto llamadas entrantes donde el cliente llama a nuestro centro de contacto. Pero un caso de uso muy común para las integraciones de Flex dentro de un CRM es **Click to Dial** (Hacer clic para llamar). En este caso, los agentes pueden hacer clic en un contacto en un CRM fuera de Flex y esto iniciará una llamada telefónica utilizando Flex.

---

## Llamadas entrantes

El flujo de llamadas entrantes sigue siendo el mismo que antes. El cliente pasa por un IVR, es enviado a Flex, y esto crea una tarea que el agente acepta en la interfaz de Flex.

La principal diferencia es que ahora, la interfaz de Flex está incrustada dentro de un CRM y se comunica con el CRM utilizando `postMessage`.

Por ejemplo, puede pasar el identificador del cliente al CRM cuando se selecciona una tarea y, en respuesta, el CRM puede cargar el perfil del cliente correspondiente.

![[Pasted image 20250210210033.png]]

---

## Llamadas salientes

Con las llamadas salientes, el flujo es el opuesto.

El CRM utiliza `postMessage` para informar a Flex sobre algún evento, por ejemplo, que un agente hizo clic en un contacto.

Luego, debes crear un plugin de Flex que reaccione a ese evento y, por ejemplo, utilice el framework de Acciones para iniciar una llamada saliente.
![[Pasted image 20250210210058.png]]

---

## Ejemplo práctico

Ahora veamos un ejemplo. Hemos preparado un repositorio con un esquema de CRM que integra Flex dentro de él, junto con un plugin de Flex que intercambia mensajes con ese CRM.

1. Comienza clonando este repositorio:
   ```bash
   git clone https://github.com/TwilioTraining/plugin-feathercorp-fx3-crm-frame.git
 ```

2. Instala las dependencias necesarias e inicia tu plugin localmente:
   ```bash
   cd plugin-feathercorp-fx3-crm-frame/
   npm install
   twilio flex:plugins:start
   ```

3. En lugar de abrir la interfaz de Flex directamente, abre el esquema del CRM dirigiéndote a `http://localhost:3000/crm.html` (asumiendo que tu interfaz de Flex se inició en el puerto 3000). Deberías ver algo como esto:

![[Pasted image 20250210210212.png]]

- **CRM**
	El CRM se actualiza automáticamente en función de la información sobre las llamadas entrantes recibidas desde Flex.
	También tiene la capacidad de iniciar llamadas salientes utilizando Flex.
- **Flex**
	Flex está integrado dentro del CRM.
	
1. Si ahora llamas a tu instancia de Flex, pasas por el IVR, solicitas ser conectado a un agente y luego seleccionas la nueva tarea como agente, deberías ver algo como esto:

![[Pasted image 20250210210352.png]]

---

## Funcionamiento interno

Comencemos con el plugin de Flex. Aquí, primero ocultamos el `CRMContainer` en la línea 42. Luego, en la línea 45, agregamos un escuchador para nuevos mensajes recibidos desde el CRM (para llamadas salientes, discutido en la siguiente sección).

Finalmente, en las líneas 50-52, utilizamos el framework de Acciones de Flex para enviar un mensaje al CRM cada vez que un agente selecciona una tarea. Pasamos la lista completa de atributos de la tarea como mensaje.

```javascript
// Si Flex se ejecuta en un iframe, oculta parte de la UI y
// configura hooks para los mensajes intercambiados entre Flex y el CRM
if (window.self !== window.top) {
  // Oculta el CRMContainer ya que Flex se muestra dentro del CRM
  flex.AgentDesktopView.defaultProps.showPanel2 = false;

  // Agrega un escuchador de eventos para mensajes provenientes del CRM
  window.addEventListener('message', receiveMessage, false);

  // Cuando un agente selecciona una tarea, usa el Framework de Acciones para
  // enviar los atributos de la tarea a la ventana principal (CRM)
  flex.Actions.addListener('afterSelectTask', (payload) => {
    if (payload.task && payload.task.attributes) {
      window.top.postMessage(payload.task.attributes);
    }
  });
}
```

En el lado del CRM, configuramos la función `receiveMessage` como el manejador de mensajes entrantes en la línea 37.

Si esto fuera un CRM real, probablemente recuperaríamos el identificador del cliente del mensaje recibido y mostraríamos el perfil correspondiente. Sin embargo, como no es un CRM real, hacemos un pequeño truco y extraemos los datos del cliente directamente del mensaje (recuerda, el plugin de Flex envía la lista completa de atributos de la tarea). Luego mostramos esos datos del cliente en las líneas 46-50.

```javascript
// Vincula receiveMessage a eventos postMessage entrantes
window.addEventListener('message', receiveMessage, false);

// Renderiza el perfil del cliente cuando se selecciona una tarea en Flex
function receiveMessage(event) {
    console.log('Datos del evento recibido: ', event.data);
    if (event.data.account_data) {
        var profileContainer = document.querySelector('#profile-container');
        var profileName = profileContainer.querySelector('#name');
        var profileImg = profileContainer.querySelector('#img');
        profileName.textContent =
            event.data.account_data.first_name +
            ' ' +
            event.data.account_data.last_name;
        profileImg.src = crmBaseUrl + event.data.account_data.img_src;
    }
}
```

---

## Habilitar llamadas salientes

Las llamadas salientes no funcionarán de inmediato y deberás habilitarlas en tu cuenta de Twilio.

2. Para habilitar las llamadas salientes desde tu instancia de Flex, dirígete a la consola de Twilio y navega a **Flex > Manage > Voice**.

3. En la sección **Flex Dialpad**, habilita el Dialpad y selecciona uno de los números de teléfono de tu cuenta como **Caller ID** (un número que los destinatarios verán como el que llama).

4. Luego selecciona una **TaskQueue** y un **TaskRouter Workflow** (si no has cambiado la configuración predeterminada de TaskRouter, solo deberías ver una opción para cada uno; siéntete libre de usarlas para esta prueba).

5. Finalmente, selecciona el **país predeterminado** que usará tu dialpad en caso de que el número de teléfono se especifique en formato nacional sin un código de país.

6. Guarda los cambios.

![dialpad-sh_NOPROCESS_.png](dialpad-sh_NOPROCESS_.png)

**Nota:** Si planeas llamar a números de teléfono fuera de EE. UU., es posible que necesites agregar los países correspondientes a los **Voice Geographic Permissions**.

---

## Código para llamadas salientes

Antes de intentar realizar una llamada saliente, veamos el código (alerta: no funcionará tal cual y necesitarás hacer un pequeño cambio).

En el lado del CRM, la función `sendMessage` pasa el número de teléfono al iframe de Flex usando `postMessage` (línea 24) cuando el usuario hace clic en el botón "Dial now".

```javascript
// Obtén referencias al número de teléfono y al botón de marcar
var btnDial = document.getElementById('dial-number');
var txtNumber = document.getElementById('phone-number');

// Obtén el objeto window del iframe de Flex
var flexRef = document.getElementById('flex').contentWindow;

// Usa postMessage para enviar el número de teléfono al iframe de Flex
function sendMessage(event) {
    event.preventDefault();
    flexRef.postMessage(txtNumber.value);
}

// Vincula sendMessage al evento de clic del botón de marcar
btnDial.addEventListener('click', sendMessage);
```

En el lado del plugin de Flex, usamos la función `receiveMessage` para manejar los mensajes enviados por el CRM. En esta función, queremos usar el framework de Acciones de Flex para iniciar una llamada saliente al número de teléfono proporcionado.

Sin embargo, el código en la línea 34 está incompleto: ¡falta el número de teléfono!

```javascript
// Usa el Framework de Acciones para iniciar una llamada saliente pasando
// los datos del evento que contienen el número de teléfono
function receiveMessage(event) {
  console.log('Mensaje recibido', event);
  flex.Actions.invokeAction('StartOutboundCall', {
    destination: '' // establece el número de teléfono recibido del CRM
  });
}
```

---

## Tu turno

¡Completa el código!

7. Completa el parámetro `destination` de la llamada saliente con el número de teléfono recibido del CRM. Si deseas una pista, avanza a la derecha.

**Pista:** El número de teléfono se envió directamente como el contenido del mensaje en la línea 24. Por lo tanto, se pasará al escuchador de eventos como `event.data`. Puedes usar eso como el valor de `destination`.

8. Cuando termines, compara tu solución con la nuestra en el siguiente paso.

---

## Solución

```javascript
function receiveMessage(event) {
  console.log('Mensaje recibido', event);
  flex.Actions.invokeAction('StartOutboundCall', {
    destination: event.data // número de teléfono recibido del CRM
  });
}
```

Una vez que hayas completado el código, intenta realizar una llamada saliente. Deberías ver algo como esto:

![outbound_call.png](outbound_call.png)

---

## Conclusión

Eso es todo sobre la integración directa de CRMs en la interfaz de Flex. En el próximo curso, discutiremos la integración de un CRM renderizando un perfil de cliente utilizando componentes personalizados de React.

¡Pero antes de irte, por favor déjanos saber qué funcionó y qué no en nuestra encuesta!
